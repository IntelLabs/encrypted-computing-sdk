# HERACLES Code Generation Framework (Reference Implementation)

The tools in this directory are the reference implementation of and Assembler codegenerator that takes a pre-generated Polynomial Instruction Set Architecture (P-ISA) program containing instructions that use an abstract, flat memory model for polynomial operations, such as those applied in homomorphic encryption (HE), and maps them to a corresponding set of instructions compatible with the HERACLES architecture, accounting for hardware restrictions, including memory management for the HERACLES memory model.

## Table of Contents
1. [Dependencies](#dependencies)
2. [Inputs](#inputs)
3. [Outputs](#outputs)
   1. [Assembler Instruction Specs](#assembler-output-instruction-specs)
4. [Executing the Assembler](#executing-the-assembler)
   1. [Running for a Pre-Generated Kernel](#running-for-a-pre-generated-kernel)
   2. [Hardware Spec Configuration](#hardware-spec-configuration)
5. [Debug Tools](./debug_tools/README.md)

## Dependencies

This project is Python based. Dependencies for the project are as follows:

- Python 3.10 or newer (Tested with 3.10)
- Python pip 22.0 or newer
- Requirements for the Python environment listed in file `requirements.txt`.

  Install with `pip`:

  ```bash
  pip3 install -r requirements.txt
  ```

It is recommended to install Python dependencies and run inside a [Python virtual environment](https://virtualenv.pypa.io/en/stable/index.html) to avoid polluting the global Python.

## Inputs

The assembler framework requires two inputs:

- **Abstract P-ISA kernel**: a kernel of instructions in abstract P-ISA where the memory model is abstracted with a flat, infinite structure.

- **Memory mapping metadata**: metadata information indicating the location where variable identifiers from the kernel are stored in the HERACLES HBM.

Kernels and metadata are structured in comma-separated value (csv) files.

P-ISA kernels, along with corresponding memory metadata required as input to the assembler, are generated by the upper layers in the Encrypted Computing SDK stack, e.g. the [Program Mapper](../../README.md#encrypted-computing-sdk-phase-1-components-and-tasks) component of the [p-ISA tools](../../p-isa_tools).

## Outputs

On a successful run, given a P-ISA kernel in file `filename.csv` (and corresponding memory metadata file), the assembler generates three files:

- `filename.minst`: contains the list of instructions for the MINST queue.
- `filename.cinst`: contains the list of instructions for the CINST queue.
- `filename.xinst`: contains the list of instructions for the XINST queue.

### Assembler Output Instruction Specs

The format for the output files and instruction set for HERACLES can be found
at [Instruction Specification](docsrc/specs.md).

## Executing the Assembler
### Running for a Pre-Generated Kernel

Given a P-ISA kernel (`filename.csv`) and corresponding memory mapping file (`filename.mem`), there are three steps to assemble them into HERACLES code.

1. Pre-process the P-ISA input kernel using `he_prep.py`.

```bash
# pre-process kernel: outputs filename.tw.csv
python3 he_prep.py filename.csv
```

2. Assemble the pre-processed result using `he_as.py`.

```bash
# use output from pre-processing as input to asm:
# outputs filename.tw.minst, filename.tw.cinst, filename.tw.xinst
python3 he_as.py filename.tw.csv --input_mem_file filename.mem
```

3. Link the assembler output into a HERACLES program using `he_link.py`.

```bash
# link assembled output (input prefix: filename.tw)
# outputs filename.minst, filename.cinst, filename.xinst
python3 he_link.py filename.tw --input_mem_file filename.mem --output_prefix filename
```

This will generate the main three output files in the same directory as the input file:

- `filename.minst`: contains the list of instructions for the MINST queue.
- `filename.cinst`: contains the list of instructions for the CINST queue.
- `filename.xinst`: contains the list of instructions for the XINST queue.

Intermediate files, if any, are kept as well.

The linker program is able to link several assembled kernels into a single HERACLES program, given a correct memory mapping for the resulting program.

This version of executing is intended for the assembler to be usable as part of a compilation pipeline.

Use commands below for more configuration information, including changing output directories, input and output filenames, etc.

```bash
python3 he_prep.py -h
python3 he_as.py -h
python3 he_link.py -h
```

### Hardware Spec Configuration

#### Default Configuration
The HERACLES assembler comes with default configurations for ISA and Memory parameters. These configurations are defined in JSON files located in the config folder:
- **ISA Specification:** config/isa_spec.json
- **Memory Specification:** config/mem_spec.json

These files contain default values for various parameters that affect the behavior of the assembler and linker. Users can modify these files directly, but it is recommended to create a copy and use the command-line flags to specify the path to the modified configuration files. This approach ensures that the original default files remain unchanged and can be used as a reference.

#### Modifying Configuration
To modify the ISA or Memory specifications, follow these steps:
- Create a Copy: Copy the default JSON files from the config folder to a new location.
- Edit the Copy: Modify the parameters in the copied JSON files as needed.
- **Specify the Path:** Use the **--isa_spec** and **--mem_spec** command-line flags to specify the path to your modified configuration files when running the scripts.

#### Additional Notes
Memory Parameters: For he_as.py and he_link.py, certain memory parameters like spad_size and hbm_size can be overwritten directly from the command line, providing flexibility in configuration without modifying the JSON files.
